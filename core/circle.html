<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Circle - SociallyFounded</title>
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    
    <!-- QR Code Scanner -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html5-qrcode/2.3.8/html5-qrcode.min.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background: linear-gradient(135deg, #003554 0%, #004a6b 100%);
            min-height: 100vh;
            color: white;
        }

        .header {
            padding: 20px;
            text-align: center;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
        }

        .header h1 {
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .header p {
            opacity: 0.9;
            font-size: 16px;
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
            padding: 20px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.95);
            color: #003554;
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            backdrop-filter: blur(10px);
        }

        .stat-number {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 14px;
            opacity: 0.7;
        }

        .action-section {
            background: rgba(255, 255, 255, 0.95);
            color: #003554;
            border-radius: 20px;
            padding: 25px;
            margin-bottom: 25px;
            backdrop-filter: blur(10px);
        }

        .section-title {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .action-buttons {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
        }

        .action-btn {
            flex: 1;
            padding: 15px;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            font-family: 'Poppins', sans-serif;
        }

        .scan-btn {
            background: #003554;
            color: white;
        }

        .scan-btn:hover {
            background: #004a6b;
            transform: translateY(-2px);
        }

        .my-qr-btn {
            background: #f8f9fa;
            color: #003554;
            border: 2px solid #e0e0e0;
        }

        .my-qr-btn:hover {
            background: #e9ecef;
            border-color: #003554;
        }

        .scanner-container {
            display: none;
            background: #f8f9fa;
            border-radius: 15px;
            padding: 20px;
            margin-top: 20px;
        }

        #qr-reader {
            width: 100%;
            border-radius: 12px;
            overflow: hidden;
        }

        .scanner-controls {
            margin-top: 15px;
            text-align: center;
        }

        .stop-scan-btn {
            background: #e74c3c;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
        }

        .circle-list {
            margin-top: 20px;
        }

        .connection-card {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 15px;
            transition: all 0.2s ease;
        }

        .connection-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .connection-avatar {
            width: 50px;
            height: 50px;
            border-radius: 25px;
            background: linear-gradient(135deg, #003554 0%, #004a6b 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 18px;
        }

        .connection-info {
            flex: 1;
        }

        .connection-name {
            font-weight: 600;
            font-size: 16px;
            margin-bottom: 2px;
        }

        .connection-details {
            font-size: 14px;
            color: #666;
        }

        .connection-passport {
            font-size: 12px;
            color: #999;
            font-family: 'Courier New', monospace;
        }

        .connection-actions {
            display: flex;
            gap: 8px;
        }

        .action-icon {
            width: 35px;
            height: 35px;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }

        .message-btn {
            background: #25D366;
            color: white;
        }

        .message-btn:hover {
            background: #128C7E;
        }

        .more-btn {
            background: #e9ecef;
            color: #666;
        }

        .more-btn:hover {
            background: #dee2e6;
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #666;
        }

        .empty-icon {
            font-size: 48px;
            margin-bottom: 15px;
            opacity: 0.3;
        }

        .loading {
            text-align: center;
            padding: 40px;
        }

        .spinner {
            width: 32px;
            height: 32px;
            border: 3px solid #e0e0e0;
            border-top: 3px solid #003554;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .success-message, .error-message {
            padding: 15px;
            border-radius: 12px;
            margin: 15px 0;
            text-align: center;
        }

        .success-message {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .error-message {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .back-nav {
            margin-bottom: 20px;
        }

        .back-btn {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
            backdrop-filter: blur(10px);
        }

        .back-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        @media (max-width: 480px) {
            .action-buttons {
                flex-direction: column;
            }
            
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .connection-card {
                padding: 12px;
            }
            
            .connection-avatar {
                width: 40px;
                height: 40px;
                font-size: 16px;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>🔗 My Circle</h1>
        <p>Build your entrepreneurial network</p>
    </div>

    <div class="container">
        <div class="back-nav">
            <button class="back-btn" onclick="window.location.href='/core/passport.html'">
                <svg width="16" height="16" fill="white" viewBox="0 0 24 24">
                    <path d="M19 12H5M12 19l-7-7 7-7" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
                Back to Passport
            </button>
        </div>

        <!-- Network Stats -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-number" id="totalConnections">0</div>
                <div class="stat-label">Total Connections</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="newThisWeek">0</div>
                <div class="stat-label">New This Week</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="foundersCount">0</div>
                <div class="stat-label">Founders</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="mentorsCount">0</div>
                <div class="stat-label">Mentors</div>
            </div>
        </div>

        <!-- Scanner Section -->
        <div class="action-section">
            <div class="section-title">
                📱 Connect with Others
            </div>
            
            <div class="action-buttons">
                <button class="action-btn scan-btn" onclick="startScanning()">
                    <svg width="20" height="20" fill="white" viewBox="0 0 24 24">
                        <path d="M3 7V5a2 2 0 0 1 2-2h2M17 3h2a2 2 0 0 1 2 2v2M21 17v2a2 2 0 0 1-2 2h-2M7 21H5a2 2 0 0 1-2-2v-2" stroke="currentColor" stroke-width="2" fill="none"/>
                        <rect x="8" y="8" width="8" height="8" rx="1" stroke="currentColor" stroke-width="2" fill="none"/>
                        <circle cx="12" cy="12" r="2" fill="currentColor"/>
                    </svg>
                    Scan QR Code
                </button>
                
                <button class="action-btn my-qr-btn" onclick="showMyQR()">
                    <svg width="20" height="20" fill="#003554" viewBox="0 0 24 24">
                        <rect x="4" y="4" width="16" height="16" rx="3" stroke="currentColor" stroke-width="2" fill="none"/>
                        <rect x="7" y="7" width="4" height="4" rx="1" fill="currentColor"/>
                        <line x1="13" y1="8" x2="17" y2="8" stroke="currentColor" stroke-width="2"/>
                        <line x1="13" y1="10" x2="15" y2="10" stroke="currentColor" stroke-width="2"/>
                        <line x1="7" y1="14" x2="17" y2="14" stroke="currentColor" stroke-width="2"/>
                        <line x1="7" y1="16" x2="13" y2="16" stroke="currentColor" stroke-width="2"/>
                    </svg>
                    Show My QR
                </button>
            </div>
            
            <div class="scanner-container" id="scannerContainer">
                <div id="qr-reader" style="width: 100%"></div>
                <div class="scanner-controls">
                    <button class="stop-scan-btn" onclick="stopScanning()">Stop Scanning</button>
                </div>
            </div>
            
            <div id="messageContainer"></div>
        </div>

        <!-- Connections List -->
        <div class="action-section">
            <div class="section-title">
                👥 Your Network
            </div>
            
            <div id="loadingConnections" class="loading">
                <div class="spinner"></div>
                <p>Loading your connections...</p>
            </div>
            
            <div id="connectionsList" class="circle-list" style="display: none;">
                <!-- Connections will be loaded here -->
            </div>
            
            <div id="emptyState" class="empty-state" style="display: none;">
                <div class="empty-icon">🤝</div>
                <h3>No connections yet</h3>
                <p>Start scanning QR codes to build your entrepreneurial network!</p>
            </div>
        </div>
    </div>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAkYSmo9aGyF9IDKXej9p_j6FZfV0SCNG0",
            authDomain: "sociallyfounded-df98f.firebaseapp.com",
            projectId: "sociallyfounded-df98f",
            storageBucket: "sociallyfounded-df98f.firebasestorage.app",
            messagingSenderId: "994533610259",
            appId: "1:994533610259:web:fe740378a4c000211e40e6",
            measurementId: "G-EY0BZE30Q0"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        let currentUser = null;
        let html5QrCode = null;
        
        // Authentication State Observer
        auth.onAuthStateChanged(async (user) => {
            if (user) {
                currentUser = user;
                await loadUserConnections();
            } else {
                window.location.href = '/';
            }
        });

        async function loadUserConnections() {
            try {
                // Get user's connections from Firestore
                const connectionsSnapshot = await db.collection('connections')
                    .where('userId', '==', currentUser.uid)
                    .orderBy('connectedAt', 'desc')
                    .get();
                
                const connections = [];
                const promises = [];
                
                connectionsSnapshot.forEach(doc => {
                    const connectionData = doc.data();
                    connections.push(connectionData);
                    
                    // Get connected user details
                    promises.push(
                        db.collection('users').doc(connectionData.connectedUserId).get()
                    );
                });
                
                const userDocs = await Promise.all(promises);
                const connectionsWithUserData = connections.map((connection, index) => ({
                    ...connection,
                    userData: userDocs[index].exists ? userDocs[index].data() : null
                }));
                
                displayConnections(connectionsWithUserData);
                updateStats(connectionsWithUserData);
                
            } catch (error) {
                console.error('Error loading connections:', error);
                showMessage('Failed to load connections', 'error');
            }
        }

        function displayConnections(connections) {
            document.getElementById('loadingConnections').style.display = 'none';
            
            if (connections.length === 0) {
                document.getElementById('emptyState').style.display = 'block';
                document.getElementById('connectionsList').style.display = 'none';
                return;
            }
            
            document.getElementById('emptyState').style.display = 'none';
            document.getElementById('connectionsList').style.display = 'block';
            
            const connectionsList = document.getElementById('connectionsList');
            connectionsList.innerHTML = connections.map(connection => {
                const userData = connection.userData;
                if (!userData) return '';
                
                const initials = userData.displayName 
                    ? userData.displayName.split(' ').map(n => n[0]).join('').substring(0, 2)
                    : 'U';
                
                const personas = [];
                if (userData.personas?.founder?.active) personas.push('Founder');
                if (userData.personas?.mentor?.active) personas.push('Mentor');
                if (userData.personas?.host?.active) personas.push('Host');
                if (userData.personas?.investor?.active) personas.push('Investor');
                if (personas.length === 0) personas.push('Member');
                
                return `
                    <div class="connection-card">
                        <div class="connection-avatar">${initials}</div>
                        <div class="connection-info">
                            <div class="connection-name">${userData.displayName || 'New Member'}</div>
                            <div class="connection-details">${personas.join(', ')}</div>
                            <div class="connection-passport">${userData.sfPassport?.id || 'No passport'}</div>
                        </div>
                        <div class="connection-actions">
                            <button class="action-icon message-btn" onclick="contactConnection('${userData.uid}')" title="Message">
                                <svg width="16" height="16" fill="white" viewBox="0 0 24 24">
                                    <rect x="4" y="6" width="16" height="12" rx="2" stroke="currentColor" stroke-width="2" fill="none"/>
                                    <path d="M4 8l8 5 8-5" stroke="currentColor" stroke-width="2" fill="none"/>
                                    <circle cx="7" cy="9" r="1" fill="currentColor"/>
                                    <circle cx="17" cy="15" r="1" fill="currentColor"/>
                                </svg>
                            </button>
                            <button class="action-icon more-btn" onclick="viewProfile('${userData.sfPassport?.id}')" title="View Profile">
                                <svg width="16" height="16" fill="currentColor" viewBox="0 0 24 24">
                                    <rect x="4" y="4" width="16" height="16" rx="3" stroke="currentColor" stroke-width="2" fill="none"/>
                                    <rect x="7" y="7" width="4" height="4" rx="1" fill="currentColor"/>
                                    <line x1="13" y1="8" x2="17" y2="8" stroke="currentColor" stroke-width="2"/>
                                    <line x1="13" y1="10" x2="15" y2="10" stroke="currentColor" stroke-width="2"/>
                                    <line x1="7" y1="14" x2="17" y2="14" stroke="currentColor" stroke-width="2"/>
                                    <line x1="7" y1="16" x2="13" y2="16" stroke="currentColor" stroke-width="2"/>
                                </svg>
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function updateStats(connections) {
            document.getElementById('totalConnections').textContent = connections.length;
            
            // Count new connections this week
            const oneWeekAgo = new Date();
            oneWeekAgo.setDate(oneWeekAgo.getDate() - 7);
            
            const newThisWeek = connections.filter(conn => 
                conn.connectedAt && conn.connectedAt.toDate() > oneWeekAgo
            ).length;
            
            document.getElementById('newThisWeek').textContent = newThisWeek;
            
            // Count by persona
            const founders = connections.filter(conn => 
                conn.userData?.personas?.founder?.active
            ).length;
            
            const mentors = connections.filter(conn => 
                conn.userData?.personas?.mentor?.active
            ).length;
            
            document.getElementById('foundersCount').textContent = founders;
            document.getElementById('mentorsCount').textContent = mentors;
        }

        function startScanning() {
            const scannerContainer = document.getElementById('scannerContainer');
            scannerContainer.style.display = 'block';
            
            html5QrCode = new Html5Qrcode("qr-reader");
            
            html5QrCode.start(
                { facingMode: "environment" },
                {
                    fps: 10,
                    qrbox: { width: 250, height: 250 }
                },
                onScanSuccess,
                onScanFailure
            ).catch(err => {
                console.error('Failed to start scanner:', err);
                showMessage('Failed to start camera. Please check permissions.', 'error');
                scannerContainer.style.display = 'none';
            });
        }

        function stopScanning() {
            if (html5QrCode) {
                html5QrCode.stop().then(() => {
                    document.getElementById('scannerContainer').style.display = 'none';
                    html5QrCode = null;
                }).catch(err => {
                    console.error('Failed to stop scanner:', err);
                });
            }
        }

        async function onScanSuccess(decodedText, decodedResult) {
            console.log('QR Code scanned:', decodedText);
            
            // Stop scanning immediately
            stopScanning();
            
            // Extract passport ID from scanned URL
            let passportId = null;
            if (decodedText.includes('sociallyfounded.com/profile/')) {
                passportId = decodedText.split('/profile/')[1];
            } else if (decodedText.startsWith('SF-')) {
                passportId = decodedText;
            }
            
            if (!passportId) {
                showMessage('Invalid QR code. Please scan a valid SF Passport.', 'error');
                return;
            }
            
            await addConnection(passportId);
        }

        function onScanFailure(error) {
            // Silent handling of scan failures
        }

        async function addConnection(passportId) {
            try {
                showMessage('Adding connection...', 'info');
                
                // Find user with this passport ID
                const usersSnapshot = await db.collection('users')
                    .where('sfPassport.id', '==', passportId)
                    .limit(1)
                    .get();
                
                if (usersSnapshot.empty) {
                    showMessage('User not found. Please check the QR code.', 'error');
                    return;
                }
                
                const targetUserDoc = usersSnapshot.docs[0];
                const targetUserId = targetUserDoc.id;
                const targetUserData = targetUserDoc.data();
                
                // Check if connection already exists
                const existingConnection = await db.collection('connections')
                    .where('userId', '==', currentUser.uid)
                    .where('connectedUserId', '==', targetUserId)
                    .limit(1)
                    .get();
                
                if (!existingConnection.empty) {
                    showMessage(`You're already connected to ${targetUserData.displayName}!`, 'error');
                    return;
                }
                
                // Check if trying to connect to self
                if (targetUserId === currentUser.uid) {
                    showMessage("You can't add yourself to your circle!", 'error');
                    return;
                }
                
                // Create bidirectional connection
                const connectionData = {
                    userId: currentUser.uid,
                    connectedUserId: targetUserId,
                    connectedAt: firebase.firestore.FieldValue.serverTimestamp(),
                    connectionMethod: 'qr_scan',
                    passportId: passportId
                };
                
                const reverseConnectionData = {
                    userId: targetUserId,
                    connectedUserId: currentUser.uid,
                    connectedAt: firebase.firestore.FieldValue.serverTimestamp(),
                    connectionMethod: 'qr_scan',
                    passportId: passportId
                };
                
                // Add both connections
                await Promise.all([
                    db.collection('connections').add(connectionData),
                    db.collection('connections').add(reverseConnectionData)
                ]);
                
                // Log activity
                await logActivity(currentUser.uid, 'connection_added', {
                    connectedTo: targetUserId,
                    method: 'qr_scan',
                    passportId: passportId
                });
                
                showMessage(`🎉 Connected to ${targetUserData.displayName}!`, 'success');
                
                // Reload connections
                setTimeout(() => {
                    loadUserConnections();
                }, 1000);
                
            } catch (error) {
                console.error('Error adding connection:', error);
                showMessage('Failed to add connection. Please try again.', 'error');
            }
        }

        async function logActivity(userId, type, data) {
            try {
                await db.collection('activities').add({
                    userId,
                    type,
                    data,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                });
            } catch (error) {
                console.error('Error logging activity:', error);
            }
        }

        function showMessage(message, type = 'info') {
            const messageContainer = document.getElementById('messageContainer');
            const className = type === 'error' ? 'error-message' : 
                             type === 'success' ? 'success-message' : 'success-message';
            
            messageContainer.innerHTML = `<div class="${className}">${message}</div>`;
            
            // Clear message after 3 seconds
            setTimeout(() => {
                messageContainer.innerHTML = '';
            }, 3000);
        }

        function showMyQR() {
            window.location.href = '/core/passport.html';
        }

        function contactConnection(userId) {
            // Future: Open messaging interface
            alert('Messaging feature coming soon!');
        }

        function viewProfile(passportId) {
            if (passportId) {
                window.open(`/profile/${passportId}`, '_blank');
            }
        }
    </script>
</body>
</html>

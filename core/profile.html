<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Profile | SociallyFounded</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background: linear-gradient(135deg, #003554 0%, #004a6b 100%);
            color: white;
            min-height: 100vh;
            overflow-x: hidden;
        }

        .header {
            padding: 1rem 2rem;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            font-size: 1.5rem;
            font-weight: 700;
            color: white;
        }

        .nav-menu {
            display: flex;
            gap: 1.5rem;
            align-items: center;
        }

        .nav-link {
            color: white;
            text-decoration: none;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            transition: all 0.3s ease;
            font-weight: 400;
        }

        .nav-link:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .nav-link.disabled {
            color: rgba(255, 255, 255, 0.5);
            cursor: not-allowed;
            pointer-events: none;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
        }

        .profile-header {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(15px);
            border-radius: 20px;
            padding: 2rem;
            margin-bottom: 2rem;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .passport-section {
            display: flex;
            align-items: center;
            gap: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .passport-badge {
            background: linear-gradient(135deg, #D4AF37 0%, #FFD700 100%);
            color: #003554;
            padding: 0.5rem 1rem;
            border-radius: 15px;
            font-weight: 600;
            font-size: 0.9rem;
        }

        .verification-status {
            padding: 0.5rem 1rem;
            border-radius: 10px;
            font-size: 0.9rem;
            font-weight: 500;
        }

        .verified {
            background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);
            color: white;
        }

        .unverified {
            background: rgba(239, 68, 68, 0.2);
            color: #fca5a5;
            border: 1px solid rgba(239, 68, 68, 0.3);
        }

        .firebase-status {
            background: rgba(59, 130, 246, 0.2);
            color: #60a5fa;
            border: 1px solid rgba(59, 130, 246, 0.3);
        }

        .profile-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
            margin-bottom: 2rem;
        }

        .profile-section {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(15px);
            border-radius: 15px;
            padding: 1.5rem;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .section-title {
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 1rem;
            color: #FFD700;
        }

        .personas-grid {
            display: grid;
            gap: 1.5rem;
            margin-top: 2rem;
        }

        .persona-card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(15px);
            border-radius: 15px;
            padding: 1.5rem;
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: all 0.3s ease;
        }

        .persona-card:hover {
            transform: translateY(-2px);
            background: rgba(255, 255, 255, 0.15);
        }

        .persona-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .persona-title {
            font-size: 1.1rem;
            font-weight: 600;
        }

        .persona-status {
            padding: 0.3rem 0.8rem;
            border-radius: 8px;
            font-size: 0.8rem;
            font-weight: 500;
        }

        .active {
            background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);
            color: white;
        }

        .requires-linkedin {
            background: rgba(251, 191, 36, 0.2);
            color: #fbbf24;
            border: 1px solid rgba(251, 191, 36, 0.3);
        }

        .coming-soon {
            background: rgba(156, 163, 175, 0.2);
            color: #9ca3af;
            border: 1px solid rgba(156, 163, 175, 0.3);
        }

        .persona-description {
            color: rgba(255, 255, 255, 0.8);
            margin-bottom: 1rem;
            line-height: 1.6;
        }

        .persona-action {
            width: 100%;
            padding: 0.8rem 1.5rem;
            border: none;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
            text-align: center;
        }

        .access-btn {
            background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);
            color: white;
        }

        .access-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(34, 197, 94, 0.3);
        }

        .linkedin-btn {
            background: linear-gradient(135deg, #0077b5 0%, #005885 100%);
            color: white;
        }

        .linkedin-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 119, 181, 0.3);
        }

        .disabled-btn {
            background: rgba(156, 163, 175, 0.3);
            color: #9ca3af;
            cursor: not-allowed;
        }

        .success-banner {
            background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);
            color: white;
            padding: 1rem 1.5rem;
            border-radius: 10px;
            margin-bottom: 2rem;
            display: none;
            animation: slideIn 0.5s ease-out;
        }

        .info-banner {
            background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
            color: white;
            padding: 1rem 1.5rem;
            border-radius: 10px;
            margin-bottom: 2rem;
            display: none;
            animation: slideIn 0.5s ease-out;
        }

        .professional-profile {
            display: none;
        }

        .professional-profile.visible {
            display: block;
        }

        .skill-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }

        .skill-tag {
            background: rgba(212, 175, 55, 0.2);
            color: #D4AF37;
            padding: 0.3rem 0.8rem;
            border-radius: 15px;
            font-size: 0.8rem;
            border: 1px solid rgba(212, 175, 55, 0.3);
        }

        .credibility-score {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-top: 1rem;
            padding: 1rem;
            background: rgba(34, 197, 94, 0.1);
            border-radius: 10px;
            border: 1px solid rgba(34, 197, 94, 0.2);
        }

        .score-number {
            font-size: 1.5rem;
            font-weight: 700;
            color: #22c55e;
        }

        .loading-indicator {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @media (max-width: 768px) {
            .container {
                padding: 1rem;
            }

            .profile-grid {
                grid-template-columns: 1fr;
            }

            .passport-section {
                flex-direction: column;
                align-items: flex-start;
                gap: 1rem;
            }

            .nav-menu {
                display: none;
            }
        }

        .debug-panel {
            position: fixed;
            top: 10px;
            right: 10px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 0.5rem;
            border-radius: 5px;
            font-size: 0.7rem;
            z-index: 1000;
            max-width: 200px;
        }
    </style>
</head>
<body>
    <div class="debug-panel" id="debugPanel">
        Firebase: <span class="loading-indicator"></span>
    </div>

    <header class="header">
        <div class="logo">SF</div>
        <nav class="nav-menu">
            <a href="../" class="nav-link">Home</a>
            <a href="../founder/ideas.html" class="nav-link" id="ideasLink">Ideas</a>
            <a href="../mentor/dashboard.html" class="nav-link" id="mentorLink">Mentor</a>
            <a href="../member/venues.html" class="nav-link">Venues</a>
            <a href="profile.html" class="nav-link">Profile</a>
        </nav>
    </header>

    <div class="container">
        <div class="success-banner" id="successBanner">
            ðŸŽ‰ Profile updated with Firebase database! Your data is now securely stored and synchronized.
        </div>

        <div class="info-banner" id="infoBanner">
            ðŸ”„ Migrating your profile to Firebase database...
        </div>

        <div class="profile-header">
            <h1>SF Member</h1>
            <div class="passport-section">
                <div class="passport-badge" id="passportBadge">SF-XXXXXX â€¢ Navy Tier â€¢ Level 1</div>
                <div class="verification-status firebase-status" id="verificationStatus">
                    <span class="loading-indicator"></span> Loading from Firebase...
                </div>
            </div>
        </div>

        <div class="professional-profile" id="professionalProfile">
            <div class="profile-grid">
                <div class="profile-section">
                    <h3 class="section-title">Professional Profile</h3>
                    <div id="profileContent">
                        <div><strong>Name:</strong> <span id="fullName">Loading...</span></div>
                        <div style="margin-top: 0.5rem;"><strong>Headline:</strong> <span id="headline">Loading...</span></div>
                        <div class="credibility-score">
                            <div class="score-number" id="credibilityScore">--</div>
                            <div>
                                <div>Credibility Score</div>
                                <div style="font-size: 0.8rem; opacity: 0.8;">Based on LinkedIn verification</div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="profile-section">
                    <h3 class="section-title">Skills & Expertise</h3>
                    <div id="skillsContent">
                        <div class="skill-tags" id="skillsTags">
                            Loading skills...
                        </div>
                    </div>
                </div>
            </div>

            <div class="profile-section">
                <h3 class="section-title">Experience</h3>
                <div id="experienceContent">
                    Loading experience...
                </div>
            </div>
        </div>

        <div class="personas-grid">
            <h2 style="color: #FFD700; margin-bottom: 1rem;">SF Personas</h2>

            <div class="persona-card">
                <div class="persona-header">
                    <h3 class="persona-title">Member</h3>
                    <span class="persona-status active">âœ… Active</span>
                </div>
                <p class="persona-description">Venue discovery, check-ins, and networking with entrepreneurs</p>
                <div style="font-size: 0.9rem; color: rgba(255, 255, 255, 0.7);">Base level access</div>
            </div>

            <div class="persona-card">
                <div class="persona-header">
                    <h3 class="persona-title">Founder</h3>
                    <span class="persona-status requires-linkedin" id="founderStatus">ðŸ”— Requires LinkedIn</span>
                </div>
                <p class="persona-description">AI-powered idea development, IP protection, and team building</p>
                <a href="../founder/ideas.html" class="persona-action linkedin-btn" id="founderAction">Connect LinkedIn</a>
            </div>

            <div class="persona-card">
                <div class="persona-header">
                    <h3 class="persona-title">Mentor</h3>
                    <span class="persona-status requires-linkedin" id="mentorStatus">ðŸ”— Requires LinkedIn</span>
                </div>
                <p class="persona-description">Guide entrepreneurs, track impact, and publish research</p>
                <a href="../mentor/dashboard.html" class="persona-action linkedin-btn" id="mentorAction">Connect LinkedIn</a>
            </div>

            <div class="persona-card">
                <div class="persona-header">
                    <h3 class="persona-title">Host</h3>
                    <span class="persona-status coming-soon">ðŸ”’ Coming Soon</span>
                </div>
                <p class="persona-description">Manage venues, analyze customers, and build revenue</p>
                <button class="persona-action disabled-btn" disabled>Business verification required</button>
            </div>

            <div class="persona-card">
                <div class="persona-header">
                    <h3 class="persona-title">Investor</h3>
                    <span class="persona-status coming-soon">ðŸ”’ Coming Soon</span>
                </div>
                <p class="persona-description">Discover deals, automated due diligence, and portfolio management</p>
                <button class="persona-action disabled-btn" disabled>Accredited investor verification</button>
            </div>
        </div>
    </div>

    <!-- Firebase v9 SDK -->
    <script type="module">
        // Import Firebase v9 SDK
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js';
        import { 
            getFirestore, 
            doc, 
            getDoc, 
            setDoc, 
            updateDoc, 
            onSnapshot,
            serverTimestamp
        } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js';
        import { 
            getAuth, 
            signInAnonymously, 
            onAuthStateChanged
        } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js';

        // Firebase Configuration - CORRECTED
        const firebaseConfig = {
            apiKey: "AIzaSyAkYSmoOAqGYGIMKYipgjPFZYWEGNG6",
            authDomain: "sociallyfounded-df98f.firebaseapp.com",
            projectId: "sociallyfounded-df98f",
            storageBucket: "sociallyfounded-df98f.firebasestorage.app",
            messagingSenderId: "994533610259",
            appId: "1:994533610259:web:fe740378a4c000211e40e6",
            measurementId: "G-EVNBZE0BQ0"
        };

        // Initialize Firebase
        let app, db, auth;
        let currentUser = null;
        let userDocRef = null;

        try {
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            
            updateDebug('Firebase: Connected âœ…');
            
        } catch (error) {
            updateDebug('Firebase: Error âŒ');
            console.error('Firebase initialization failed:', error);
        }

        function updateDebug(message) {
            const debugEl = document.getElementById('debugPanel');
            if (debugEl) {
                debugEl.innerHTML = message;
            }
        }

        // Authentication state listener
        onAuthStateChanged(auth, async (user) => {
            currentUser = user;
            
            if (user) {
                userDocRef = doc(db, 'users', user.uid);
                await loadUserProfile();
                setupRealtimeUpdates();
            } else {
                // Sign in anonymously if no user
                await signInAnonymously(auth);
            }
        });

        // Load user profile from Firestore
        async function loadUserProfile() {
            try {
                updateDebug('Firebase: Loading profile...');
                
                const userDoc = await getDoc(userDocRef);
                
                if (userDoc.exists()) {
                    const userData = userDoc.data();
                    displayUserProfile(userData);
                    updateDebug('Firebase: Profile loaded âœ…');
                } else {
                    // User document doesn't exist, check localStorage for migration
                    await attemptMigration();
                }
                
            } catch (error) {
                console.error('Failed to load user profile:', error);
                updateDebug('Firebase: Load error âŒ');
                showErrorFallback();
            }
        }

        // Attempt to migrate from localStorage
        async function attemptMigration() {
            try {
                updateDebug('Firebase: Checking migration...');
                
                const localStorageData = localStorage.getItem('sf_user');
                
                if (localStorageData) {
                    showInfoBanner('Migrating your profile to Firebase database...');
                    
                    const localUser = JSON.parse(localStorageData);
                    
                    // Create new Firestore user document
                    const newUserData = {
                        uid: currentUser.uid,
                        displayName: localUser.professionalProfile?.fullName || 'SF Member',
                        email: currentUser.email || 'member@sociallyfounded.com',
                        createdAt: serverTimestamp(),
                        migratedAt: serverTimestamp(),
                        migratedFrom: 'localStorage',
                        
                        sfPassport: {
                            id: localUser.passportId || generatePassportId(),
                            level: localUser.passport?.level || 1,
                            tier: localUser.passport?.tier || 'Navy',
                            experience: localUser.passport?.experience || 100
                        },
                        
                        personas: localUser.personas || {
                            member: { active: true, activatedAt: serverTimestamp() },
                            founder: { active: false, linkedinVerified: false },
                            mentor: { active: false, linkedinVerified: false },
                            host: { active: false, businessVerified: false },
                            investor: { active: false, accreditationVerified: false }
                        },
                        
                        verification: localUser.verification || {
                            linkedin: { verified: false }
                        },
                        
                        professionalProfile: localUser.professionalProfile || null
                    };
                    
                    await setDoc(userDocRef, newUserData);
                    
                    // Display migrated profile
                    displayUserProfile(newUserData);
                    showSuccessBanner();
                    updateDebug('Firebase: Migrated âœ…');
                    
                } else {
                    // No localStorage data, create new user
                    await createNewUser();
                }
                
            } catch (error) {
                console.error('Migration failed:', error);
                updateDebug('Firebase: Migration error âŒ');
                await createNewUser();
            }
        }

        // Create new user document
        async function createNewUser() {
            try {
                const newUserData = {
                    uid: currentUser.uid,
                    displayName: 'SF Member',
                    email: currentUser.email || 'member@sociallyfounded.com',
                    createdAt: serverTimestamp(),
                    
                    sfPassport: {
                        id: generatePassportId(),
                        level: 1,
                        tier: 'Navy',
                        experience: 100
                    },
                    
                    personas: {
                        member: { active: true, activatedAt: serverTimestamp() },
                        founder: { active: false, linkedinVerified: false },
                        mentor: { active: false, linkedinVerified: false },
                        host: { active: false, businessVerified: false },
                        investor: { active: false, accreditationVerified: false }
                    },
                    
                    verification: {
                        linkedin: { verified: false }
                    }
                };
                
                await setDoc(userDocRef, newUserData);
                displayUserProfile(newUserData);
                updateDebug('Firebase: New user âœ…');
                
            } catch (error) {
                console.error('Failed to create new user:', error);
                updateDebug('Firebase: Create error âŒ');
                showErrorFallback();
            }
        }

        // Display user profile in UI
        function displayUserProfile(userData) {
            // Update passport
            const passportBadge = document.getElementById('passportBadge');
            if (userData.sfPassport) {
                passportBadge.textContent = `${userData.sfPassport.id} â€¢ ${userData.sfPassport.tier} Tier â€¢ Level ${userData.sfPassport.level}`;
            }

            // Update verification status
            const verificationStatus = document.getElementById('verificationStatus');
            const isLinkedInVerified = userData.verification?.linkedin?.verified;
            
            if (isLinkedInVerified) {
                verificationStatus.textContent = 'LinkedIn Verified';
                verificationStatus.className = 'verification-status verified';
                
                // Show professional profile
                const professionalProfile = document.getElementById('professionalProfile');
                professionalProfile.classList.add('visible');
                
                // Populate professional data
                if (userData.professionalProfile) {
                    document.getElementById('fullName').textContent = userData.professionalProfile.fullName;
                    document.getElementById('headline').textContent = userData.professionalProfile.headline;
                    document.getElementById('credibilityScore').textContent = userData.professionalProfile.credibilityScore;

                    // Display skills
                    const skillsContainer = document.getElementById('skillsTags');
                    skillsContainer.innerHTML = '';
                    userData.professionalProfile.skills?.forEach(skill => {
                        const skillTag = document.createElement('span');
                        skillTag.className = 'skill-tag';
                        skillTag.textContent = skill;
                        skillsContainer.appendChild(skillTag);
                    });

                    // Display experience
                    const experienceContainer = document.getElementById('experienceContent');
                    experienceContainer.innerHTML = '';
                    userData.professionalProfile.positions?.forEach(position => {
                        const expDiv = document.createElement('div');
                        expDiv.style.marginBottom = '0.5rem';
                        expDiv.innerHTML = `<strong>${position.title}</strong> at ${position.companyName}`;
                        experienceContainer.appendChild(expDiv);
                    });
                }
                
                updatePersonasForVerified();
                updateNavigation(true);
                
            } else {
                verificationStatus.textContent = 'Unverified';
                verificationStatus.className = 'verification-status unverified';
                updatePersonasForUnverified();
                updateNavigation(false);
            }
        }

        // Setup real-time updates
        function setupRealtimeUpdates() {
            if (!userDocRef) return;
            
            onSnapshot(userDocRef, (doc) => {
                if (doc.exists()) {
                    const userData = doc.data();
                    displayUserProfile(userData);
                    updateDebug('Firebase: Live sync âœ…');
                }
            });
        }

        // Update personas for verified user
        function updatePersonasForVerified() {
            // Update Founder persona
            const founderStatus = document.getElementById('founderStatus');
            const founderAction = document.getElementById('founderAction');
            founderStatus.textContent = 'âœ… Verified';
            founderStatus.className = 'persona-status active';
            founderAction.textContent = 'Access Founder Tools';
            founderAction.className = 'persona-action access-btn';
            founderAction.href = '../founder/ideas.html';

            // Update Mentor persona
            const mentorStatus = document.getElementById('mentorStatus');
            const mentorAction = document.getElementById('mentorAction');
            mentorStatus.textContent = 'âœ… Verified';
            mentorStatus.className = 'persona-status active';
            mentorAction.textContent = 'Access Mentor Dashboard';
            mentorAction.className = 'persona-action access-btn';
            mentorAction.href = '../mentor/dashboard.html';
        }

        // Update personas for unverified user
        function updatePersonasForUnverified() {
            // Reset Founder persona
            const founderStatus = document.getElementById('founderStatus');
            const founderAction = document.getElementById('founderAction');
            founderStatus.textContent = 'ðŸ”— Requires LinkedIn';
            founderStatus.className = 'persona-status requires-linkedin';
            founderAction.textContent = 'Connect LinkedIn';
            founderAction.className = 'persona-action linkedin-btn';
            founderAction.href = '../linkedin-elevation.html';

            // Reset Mentor persona
            const mentorStatus = document.getElementById('mentorStatus');
            const mentorAction = document.getElementById('mentorAction');
            mentorStatus.textContent = 'ðŸ”— Requires LinkedIn';
            mentorStatus.className = 'persona-status requires-linkedin';
            mentorAction.textContent = 'Connect LinkedIn';
            mentorAction.className = 'persona-action linkedin-btn';
            mentorAction.href = '../linkedin-elevation.html';
        }

        // Update navigation
        function updateNavigation(isVerified) {
            const ideasLink = document.getElementById('ideasLink');
            const mentorLink = document.getElementById('mentorLink');

            if (isVerified) {
                ideasLink.classList.remove('disabled');
                mentorLink.classList.remove('disabled');
            } else {
                ideasLink.classList.add('disabled');
                mentorLink.classList.add('disabled');
            }
        }

        // Show error fallback
        function showErrorFallback() {
            const verificationStatus = document.getElementById('verificationStatus');
            verificationStatus.textContent = 'Database Error - Using Local Mode';
            verificationStatus.className = 'verification-status unverified';
            
            // Fall back to localStorage if available
            const localData = localStorage.getItem('sf_user');
            if (localData) {
                try {
                    const userData = JSON.parse(localData);
                    displayUserProfile(userData);
                } catch (e) {
                    console.error('Failed to parse localStorage data:', e);
                }
            }
        }

        // Show banners
        function showSuccessBanner() {
            const banner = document.getElementById('successBanner');
            banner.style.display = 'block';
            setTimeout(() => {
                banner.style.display = 'none';
            }, 5000);
        }

        function showInfoBanner(message) {
            const banner = document.getElementById('infoBanner');
            banner.textContent = message;
            banner.style.display = 'block';
            setTimeout(() => {
                banner.style.display = 'none';
            }, 3000);
        }

        // Utility functions
        function generatePassportId() {
            const today = new Date();
            const dateStr = today.getFullYear().toString() + 
                           (today.getMonth() + 1).toString().padStart(2, '0') + 
                           today.getDate().toString().padStart(2, '0');
            const randomNum = Math.floor(Math.random() * 99) + 1;
            return `SF-${dateStr}-${randomNum.toString().padStart(2, '0')}`;
        }

        // Handle LinkedIn return
        function checkURLParameters() {
            const urlParams = new URLSearchParams(window.location.search);
            const elevated = urlParams.get('elevated');
            const linkedinData = urlParams.get('linkedin');
            
            if (elevated === 'true' && linkedinData && currentUser) {
                try {
                    const data = JSON.parse(decodeURIComponent(linkedinData));
                    handleLinkedInSuccess(data);
                    
                    // Clean URL
                    const cleanUrl = window.location.protocol + "//" + window.location.host + window.location.pathname;
                    window.history.replaceState({}, document.title, cleanUrl);
                } catch (e) {
                    console.error('Failed to parse LinkedIn data from URL:', e);
                }
            }
        }

        // Handle LinkedIn success
        async function handleLinkedInSuccess(linkedinData) {
            if (!currentUser || !userDocRef) return;
            
            try {
                await updateDoc(userDocRef, {
                    'verification.linkedin.verified': true,
                    'verification.linkedin.connectedAt': serverTimestamp(),
                    'personas.founder.active': true,
                    'personas.founder.linkedinVerified': true,
                    'personas.mentor.active': true,
                    'personas.mentor.linkedinVerified': true,
                    professionalProfile: linkedinData.professionalProfile,
                    lastUpdated: serverTimestamp()
                });
                
                showSuccessBanner();
                updateDebug('Firebase: LinkedIn updated âœ…');
                
            } catch (error) {
                console.error('Failed to update LinkedIn data:', error);
                updateDebug('Firebase: Update error âŒ');
            }
        }

        // Check URL parameters on load
        setTimeout(checkURLParameters, 1000);

        // Debug functions
        window.sfFirebaseDebug = {
            user: () => currentUser,
            doc: () => userDocRef,
            reset: async () => {
                if (userDocRef) {
                    await updateDoc(userDocRef, {
                        'verification.linkedin.verified': false,
                        'personas.founder.active': false,
                        'personas.founder.linkedinVerified': false,
                        'personas.mentor.active': false,
                        'personas.mentor.linkedinVerified': false,
                        professionalProfile: null
                    });
                }
            }
        };
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SociallyFounded - Where founding is socially enhanced</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background: linear-gradient(135deg, #003554 0%, #004a6b 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .auth-container {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 40px;
            width: 100%;
            max-width: 400px;
            text-align: center;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(10px);
        }

        .sf-logo {
            width: 80px;
            height: 80px;
            background: #003554;
            border-radius: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 30px;
            color: white;
            font-size: 2rem;
            font-weight: 700;
            box-shadow: 0 5px 15px rgba(0, 53, 84, 0.3);
        }

        .brand-title {
            font-size: 2rem;
            font-weight: 700;
            color: #003554;
            margin-bottom: 10px;
        }

        .brand-tagline {
            font-size: 1rem;
            color: #666;
            margin-bottom: 40px;
        }

        .auth-buttons {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .auth-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            padding: 15px 20px;
            border: none;
            border-radius: 12px;
            font-family: 'Poppins', sans-serif;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
        }

        .auth-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
        }

        .google-btn {
            background: white;
            color: #333;
            border: 2px solid #e0e0e0;
        }

        .google-btn:hover {
            border-color: #4285f4;
        }

        .email-btn {
            background: #003554;
            color: white;
        }

        .email-btn:hover {
            background: #004a6b;
        }

        .phone-btn {
            background: #25d366;
            color: white;
        }

        .phone-btn:hover {
            background: #22c55e;
        }

        .divider {
            margin: 20px 0;
            color: #999;
            position: relative;
        }

        .divider::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 0;
            right: 0;
            height: 1px;
            background: #e0e0e0;
        }

        .divider span {
            background: rgba(255, 255, 255, 0.95);
            padding: 0 15px;
            position: relative;
        }

        .guest-btn {
            background: #f8f9fa;
            color: #666;
            border: 2px solid #e0e0e0;
        }

        .guest-btn:hover {
            background: #e9ecef;
        }

        .success-message {
            background: rgba(16, 185, 129, 0.1);
            border: 1px solid #10b981;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 30px;
            color: #10b981;
        }

        .welcome-section {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 30px;
            margin-top: 30px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .passport-info {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
            text-align: left;
        }

        .info-item {
            display: flex;
            justify-content: space-between;
            font-size: 0.9rem;
        }

        .info-label {
            color: #666;
        }

        .info-value {
            color: #003554;
            font-weight: 600;
        }

        .continue-btn {
            background: #003554;
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 12px;
            font-family: 'Poppins', sans-serif;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            margin-top: 20px;
            transition: all 0.3s ease;
        }

        .continue-btn:hover {
            background: #004a6b;
            transform: translateY(-2px);
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #003554;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-left: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .hidden {
            display: none;
        }

        /* Profile preview */
        .profile-preview {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
            padding: 15px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 12px;
        }

        .profile-photo {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            object-fit: cover;
        }

        .profile-placeholder {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: #003554;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
        }

        /* Icons using CSS */
        .icon-google::before {
            content: "üîç";
            font-size: 1.2rem;
        }

        .icon-email::before {
            content: "‚úâÔ∏è";
            font-size: 1.2rem;
        }

        .icon-phone::before {
            content: "üì±";
            font-size: 1.2rem;
        }

        .icon-user::before {
            content: "üë§";
            font-size: 1.2rem;
        }

        .icon-celebration::before {
            content: "üéâ";
            font-size: 1.2rem;
            margin-right: 8px;
        }

        @media (max-width: 480px) {
            .auth-container {
                padding: 30px 20px;
            }
            
            .brand-title {
                font-size: 1.5rem;
            }
            
            .passport-info {
                grid-template-columns: 1fr;
            }
        }
    </style>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>
    <div class="auth-container">
        <!-- Initial Authentication Form -->
        <div id="authForm">
            <div class="sf-logo">SF</div>
            <h1 class="brand-title">SociallyFounded</h1>
            <p class="brand-tagline">Where founding is socially enhanced</p>

            <div class="auth-buttons">
                <button class="auth-btn google-btn" onclick="signInWithGoogle()">
                    <span class="icon-google"></span>
                    Continue with Google
                </button>
                
                <button class="auth-btn email-btn" onclick="signInWithEmail()">
                    <span class="icon-email"></span>
                    Continue with Email
                </button>
                
                <button class="auth-btn phone-btn" onclick="signInWithPhone()">
                    <span class="icon-phone"></span>
                    Continue with Phone
                </button>
            </div>

            <div class="divider">
                <span>or</span>
            </div>

            <button class="auth-btn guest-btn" onclick="continueAsGuest()">
                <span class="icon-user"></span>
                Just browsing (Guest)
            </button>
        </div>

        <!-- Success State -->
        <div id="successState" class="hidden">
            <div class="success-message">
                <strong>üéâ Welcome! Your SF Passport has been issued.</strong>
            </div>

            <div class="welcome-section">
                <!-- Profile Preview -->
                <div class="profile-preview" id="profilePreview">
                    <div class="profile-placeholder" id="profilePhotoPreview">SF</div>
                    <div>
                        <div style="font-weight: 600; color: #003554;" id="previewName">Loading...</div>
                        <div style="font-size: 0.9rem; color: #666;" id="previewEmail">Loading...</div>
                    </div>
                </div>

                <h2 style="color: #003554; margin-bottom: 20px;">
                    <span class="icon-celebration"></span>Welcome to SociallyFounded!
                </h2>

                <div class="passport-info">
                    <div class="info-item">
                        <span class="info-label">SF Passport:</span>
                        <span class="info-value" id="passportId">Generating...</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Issued By:</span>
                        <span class="info-value" id="issuingAuthority">SociallyFounded United States</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Member Level:</span>
                        <span class="info-value">Navy Level 1</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Active Personas:</span>
                        <span class="info-value">Member</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Photo Source:</span>
                        <span class="info-value" id="photoSource">Detected automatically</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Profile Status:</span>
                        <span class="info-value">‚úÖ Ready</span>
                    </div>
                </div>

                <button class="continue-btn" onclick="goToProfile()">
                    Continue to Your Passport
                </button>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { 
            getAuth, 
            GoogleAuthProvider, 
            signInWithPopup, 
            createUserWithEmailAndPassword,
            signInWithEmailAndPassword,
            signInAnonymously,
            onAuthStateChanged 
        } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { 
            getFirestore, 
            doc, 
            setDoc, 
            getDoc,
            serverTimestamp 
        } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAkYSmo9aGyF9IDKXej9p_j6FZfV0SCNG0",
            authDomain: "sociallyfounded-df98f.firebaseapp.com",
            projectId: "sociallyfounded-df98f",
            storageBucket: "sociallyfounded-df98f.firebasestorage.app",
            messagingSenderId: "994533610259",
            appId: "1:994533610259:web:fe740378a4c000211e40e6",
            measurementId: "G-EY0BZE30Q0"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Check if user is already authenticated
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                await showSuccessState(user);
            }
        });

        // Authentication functions
        window.signInWithGoogle = async function() {
            try {
                const provider = new GoogleAuthProvider();
                // Request additional profile information
                provider.addScope('profile');
                provider.addScope('email');
                
                const result = await signInWithPopup(auth, provider);
                await createUserDocument(result.user);
            } catch (error) {
                console.error('Google sign in error:', error);
                alert('Sign in failed. Please try again.');
            }
        };

        window.signInWithEmail = async function() {
            const email = prompt('Enter your email:');
            if (!email) return;

            const password = prompt('Enter your password (or create a new one):');
            if (!password) return;

            try {
                // Try to sign in first
                try {
                    const result = await signInWithEmailAndPassword(auth, email, password);
                    await createUserDocument(result.user);
                } catch (signInError) {
                    // If sign in fails, try to create new account
                    if (signInError.code === 'auth/user-not-found') {
                        const result = await createUserWithEmailAndPassword(auth, email, password);
                        await createUserDocument(result.user);
                    } else {
                        throw signInError;
                    }
                }
            } catch (error) {
                console.error('Email sign in error:', error);
                alert('Sign in failed. Please check your email and password.');
            }
        };

        window.signInWithPhone = async function() {
            // For now, use anonymous auth as phone auth requires additional setup
            alert('Phone authentication coming soon! Using guest access for now.');
            await continueAsGuest();
        };

        window.continueAsGuest = async function() {
            try {
                const result = await signInAnonymously(auth);
                await createUserDocument(result.user);
            } catch (error) {
                console.error('Anonymous sign in error:', error);
                alert('Guest access failed. Please try again.');
            }
        };

        async function createUserDocument(user) {
            try {
                const userRef = doc(db, 'users', user.uid);
                const userSnap = await getDoc(userRef);

                if (!userSnap.exists()) {
                    // Generate SF Passport ID
                    const passportId = generatePassportId();
                    
                    // Determine photo source and URL
                    let photoSource = 'Manual upload';
                    let inheritedPhotoURL = null;
                    
                    if (user.photoURL && user.providerData.some(p => p.providerId === 'google.com')) {
                        photoSource = 'Google account';
                        inheritedPhotoURL = user.photoURL;
                    }
                    
                    const userData = {
                        uid: user.uid,
                        displayName: user.displayName || user.email?.split('@')[0] || 'SF Member',
                        email: user.email || 'guest@sociallyfounded.com',
                        photoURL: user.photoURL || null,
                        inheritedPhotoURL: inheritedPhotoURL,
                        photoSource: photoSource,
                        createdAt: serverTimestamp(),
                        lastLoginAt: serverTimestamp(),
                        
                        sfPassport: {
                            id: passportId,
                            level: 1,
                            tier: 'Navy',
                            experience: 0
                        },
                        
                        personas: {
                            member: { active: true, activatedAt: serverTimestamp() }
                        },
                        
                        verification: {
                            linkedin: { verified: false }
                        }
                    };

                    await setDoc(userRef, userData);
                } else {
                    // Update last login
                    await setDoc(userRef, { 
                        lastLoginAt: serverTimestamp() 
                    }, { merge: true });
                }

                await showSuccessState(user);
            } catch (error) {
                console.error('Error creating user document:', error);
                alert('Account setup failed. Please try again.');
            }
        }

        function generatePassportId() {
            // Simple ID generation - in production, this would be more sophisticated
            const year = new Date().getFullYear().toString().slice(-2);
            const month = (new Date().getMonth() + 1).toString().padStart(2, '0');
            const day = new Date().getDate().toString().padStart(2, '0');
            const random = Math.floor(Math.random() * 100).toString().padStart(2, '0');
            return `SF-US-${year}${month}${day}${random}`;
        }

        async function showSuccessState(user) {
            // Hide auth form, show success
            document.getElementById('authForm').classList.add('hidden');
            document.getElementById('successState').classList.remove('hidden');

            // Get user data from Firestore
            try {
                const userRef = doc(db, 'users', user.uid);
                const userSnap = await getDoc(userRef);
                
                if (userSnap.exists()) {
                    const userData = userSnap.data();
                    
                    // Update UI with user data
                    document.getElementById('passportId').textContent = userData.sfPassport?.id || 'SF-US-000000';
                    document.getElementById('previewName').textContent = userData.displayName || 'SF Member';
                    document.getElementById('previewEmail').textContent = userData.email || 'guest@sociallyfounded.com';
                    document.getElementById('photoSource').textContent = userData.photoSource || 'Manual upload';

                    // Update profile photo preview
                    const photoPreview = document.getElementById('profilePhotoPreview');
                    
                    if (userData.inheritedPhotoURL || user.photoURL) {
                        const photoUrl = userData.inheritedPhotoURL || user.photoURL;
                        photoPreview.innerHTML = `<img src="${photoUrl}" alt="Profile" class="profile-photo">`;
                    } else {
                        const initials = (userData.displayName || 'SF').split(' ').map(n => n[0]).join('').toUpperCase().slice(0, 2);
                        photoPreview.textContent = initials;
                    }
                }
            } catch (error) {
                console.error('Error fetching user data:', error);
            }
        }

        window.goToProfile = function() {
            window.location.href = '/core/passport.html';
        };
    </script>
</body>
</html>

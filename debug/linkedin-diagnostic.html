<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LinkedIn OAuth Diagnostic - SociallyFounded</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Poppins', sans-serif;
            background: #FFFFFF;
            color: #003554;
            min-height: 100vh;
            padding: 20px;
        }
        
        .diagnostic-container {
            max-width: 1000px;
            margin: 0 auto;
            background: #FFFFFF;
            border: 2px solid #003554;
            border-radius: 12px;
            padding: 30px;
        }
        
        .sf-logo {
            height: 40px;
            margin-bottom: 20px;
        }
        
        h1 {
            color: #003554;
            font-weight: 600;
            margin-bottom: 20px;
        }
        
        h2 {
            color: #003554;
            font-weight: 500;
            margin: 30px 0 15px 0;
        }
        
        .status-box {
            padding: 20px;
            border-radius: 8px;
            margin: 15px 0;
        }
        
        .status-pass {
            background: #e8f5e8;
            border: 1px solid #4caf50;
            color: #2e7d32;
        }
        
        .status-fail {
            background: #ffebee;
            border: 1px solid #f44336;
            color: #d32f2f;
        }
        
        .status-warning {
            background: #fff3e0;
            border: 1px solid #ff9800;
            color: #f57c00;
        }
        
        .test-btn {
            background: #0077B5;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            font-family: 'Poppins', sans-serif;
            font-weight: 500;
            cursor: pointer;
            margin: 10px 10px 10px 0;
            transition: all 0.3s ease;
        }
        
        .test-btn:hover {
            background: #005885;
        }
        
        .test-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        
        .test-btn.danger {
            background: #f44336;
        }
        
        .test-btn.success {
            background: #4caf50;
        }
        
        .code-block {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 15px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            margin: 10px 0;
            overflow-x: auto;
            white-space: pre-wrap;
        }
        
        .api-response {
            background: #1e1e1e;
            color: #00ff00;
            padding: 15px;
            border-radius: 8px;
            font-family: monospace;
            font-size: 13px;
            max-height: 300px;
            overflow-y: auto;
            margin: 10px 0;
        }
        
        .step-number {
            background: #003554;
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            margin-right: 10px;
        }
        
        .linkedin-urls {
            background: #f0f8ff;
            border: 1px solid #0077B5;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
        }
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <div class="diagnostic-container">
        <img src="https://sociallyfounded.com/assets/sf-logo.png" alt="SociallyFounded" class="sf-logo">
        
        <h1>üîç LinkedIn OAuth Diagnostic Tool</h1>
        
        <div class="status-box status-pass">
            <h3>‚úÖ Environment Variables Confirmed</h3>
            <p><strong>LINKEDIN_CLIENT_ID:</strong> 77tpngrlwmwnz7</p>
            <p><strong>LINKEDIN_CLIENT_SECRET:</strong> WPL_AP1.vV3sYWZIFx13yovS.Y/eb9w== ‚úì</p>
            <p><em>Both values are correctly set in Vercel and match LinkedIn app configuration.</em></p>
        </div>

        <h2><span class="step-number">1</span>Test API Endpoint</h2>
        <p>First, let's verify your API endpoint is deployed and accessible:</p>
        <button class="test-btn" onclick="testAPIEndpoint()" id="apiTestBtn">üîç Test API Endpoint</button>
        <div id="apiResults"></div>

        <h2><span class="step-number">2</span>Check LinkedIn App Configuration</h2>
        <div class="linkedin-urls">
            <h4>üîó Required LinkedIn App Settings:</h4>
            <p><strong>Go to:</strong> <a href="https://developer.linkedin.com/apps/3471394/auth" target="_blank">LinkedIn Developer Portal ‚Üí Your App ‚Üí Auth Tab</a></p>
            
            <h5>‚úÖ Authorized redirect URLs (must include ALL of these):</h5>
            <div class="code-block">https://sociallyfounded.com/linkedin-callback.html
https://www.sociallyfounded.com/linkedin-callback.html
https://socially-founded.vercel.app/linkedin-callback.html</div>
            
            <h5>‚úÖ OAuth 2.0 scopes (must be enabled):</h5>
            <div class="code-block">openid
profile  
email</div>
            
            <button class="test-btn" onclick="checkLinkedInConfig()">üìã Verify LinkedIn App Config</button>
        </div>

        <h2><span class="step-number">3</span>Test CORS and Headers</h2>
        <button class="test-btn" onclick="testCORS()" id="corsTestBtn">üåê Test CORS Configuration</button>
        <div id="corsResults"></div>

        <h2><span class="step-number">4</span>Simulate LinkedIn OAuth Flow</h2>
        <p>Test the complete OAuth flow with your actual API:</p>
        <button class="test-btn" onclick="simulateOAuthFlow()" id="oauthTestBtn">üß™ Simulate OAuth Exchange</button>
        <div id="oauthResults"></div>

        <h2><span class="step-number">5</span>Real LinkedIn Test</h2>
        <div class="status-box status-warning">
            <h4>‚ö†Ô∏è Before Testing:</h4>
            <ol style="margin: 10px 0 0 20px;">
                <li>Verify API endpoint is working (Step 1)</li>
                <li>Confirm LinkedIn app redirect URLs are set (Step 2)</li>
                <li>Check CORS allows your domain (Step 3)</li>
                <li>Test OAuth simulation passes (Step 4)</li>
            </ol>
        </div>
        <button class="test-btn danger" onclick="testRealLinkedIn()" id="realTestBtn" disabled>üîó Test Real LinkedIn OAuth</button>
        
        <div id="diagnosticSummary" style="display: none; margin-top: 30px;">
            <h2>üìä Diagnostic Summary</h2>
            <div id="summaryContent"></div>
        </div>
    </div>

    <script>
        const API_ENDPOINT = '/api/linkedin/exchange-token';
        const LINKEDIN_CLIENT_ID = '77tpngrlwmwnz7';
        const REDIRECT_URI = window.location.origin + '/linkedin-callback.html';
        
        let testResults = {
            apiWorking: false,
            corsWorking: false,
            oauthWorking: false
        };

        async function testAPIEndpoint() {
            const btn = document.getElementById('apiTestBtn');
            const results = document.getElementById('apiResults');
            
            btn.disabled = true;
            btn.textContent = 'üîÑ Testing...';
            
            results.innerHTML = '<div class="status-box status-warning"><i class="fas fa-spinner fa-spin"></i> Testing API endpoint availability...</div>';
            
            try {
                // Test OPTIONS request first (CORS preflight)
                const optionsResponse = await fetch(API_ENDPOINT, {
                    method: 'OPTIONS',
                    headers: {
                        'Origin': window.location.origin
                    }
                });
                
                let apiStatus = 'API endpoint exists';
                let statusClass = 'status-pass';
                
                if (!optionsResponse.ok) {
                    apiStatus = `API endpoint returns ${optionsResponse.status}`;
                    statusClass = 'status-warning';
                }
                
                // Test POST with invalid data to see if endpoint responds
                try {
                    const postResponse = await fetch(API_ENDPOINT, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Origin': window.location.origin
                        },
                        body: JSON.stringify({ test: 'diagnostic' })
                    });
                    
                    const responseText = await postResponse.text();
                    
                    results.innerHTML = `
                        <div class="status-box ${statusClass}">
                            <h4>‚úÖ ${apiStatus}</h4>
                            <p><strong>OPTIONS Status:</strong> ${optionsResponse.status}</p>
                            <p><strong>POST Status:</strong> ${postResponse.status}</p>
                        </div>
                        <div class="api-response">
POST ${API_ENDPOINT}
Status: ${postResponse.status}
Response: ${responseText.substring(0, 500)}${responseText.length > 500 ? '...' : ''}
                        </div>
                    `;
                    
                    testResults.apiWorking = true;
                    updateRealTestButton();
                    
                } catch (postError) {
                    results.innerHTML = `
                        <div class="status-box status-fail">
                            <h4>‚ùå API POST request failed</h4>
                            <p><strong>Error:</strong> ${postError.message}</p>
                        </div>
                    `;
                }
                
            } catch (error) {
                results.innerHTML = `
                    <div class="status-box status-fail">
                        <h4>‚ùå API endpoint not reachable</h4>
                        <p><strong>Error:</strong> ${error.message}</p>
                        <p><strong>Endpoint:</strong> ${API_ENDPOINT}</p>
                    </div>
                `;
            }
            
            btn.disabled = false;
            btn.textContent = 'üîç Test API Endpoint';
        }

        async function testCORS() {
            const btn = document.getElementById('corsTestBtn');
            const results = document.getElementById('corsResults');
            
            btn.disabled = true;
            btn.textContent = 'üîÑ Testing...';
            
            results.innerHTML = '<div class="status-box status-warning"><i class="fas fa-spinner fa-spin"></i> Testing CORS configuration...</div>';
            
            try {
                const response = await fetch(API_ENDPOINT, {
                    method: 'OPTIONS',
                    headers: {
                        'Origin': window.location.origin,
                        'Access-Control-Request-Method': 'POST',
                        'Access-Control-Request-Headers': 'Content-Type'
                    }
                });
                
                const corsHeaders = {
                    'Access-Control-Allow-Origin': response.headers.get('Access-Control-Allow-Origin'),
                    'Access-Control-Allow-Methods': response.headers.get('Access-Control-Allow-Methods'),
                    'Access-Control-Allow-Headers': response.headers.get('Access-Control-Allow-Headers')
                };
                
                let corsStatus = 'status-pass';
                let corsMessage = '‚úÖ CORS configuration is correct';
                
                if (!corsHeaders['Access-Control-Allow-Origin']) {
                    corsStatus = 'status-fail';
                    corsMessage = '‚ùå No CORS Allow-Origin header found';
                } else if (corsHeaders['Access-Control-Allow-Origin'] !== window.location.origin && 
                          corsHeaders['Access-Control-Allow-Origin'] !== '*') {
                    corsStatus = 'status-warning';
                    corsMessage = '‚ö†Ô∏è CORS Allow-Origin may not match current domain';
                }
                
                results.innerHTML = `
                    <div class="status-box ${corsStatus}">
                        <h4>${corsMessage}</h4>
                        <p><strong>Current Origin:</strong> ${window.location.origin}</p>
                        <p><strong>Allowed Origin:</strong> ${corsHeaders['Access-Control-Allow-Origin'] || 'None'}</p>
                    </div>
                    <div class="api-response">
CORS Headers:
${JSON.stringify(corsHeaders, null, 2)}
                    </div>
                `;
                
                if (corsStatus === 'status-pass') {
                    testResults.corsWorking = true;
                    updateRealTestButton();
                }
                
            } catch (error) {
                results.innerHTML = `
                    <div class="status-box status-fail">
                        <h4>‚ùå CORS test failed</h4>
                        <p><strong>Error:</strong> ${error.message}</p>
                    </div>
                `;
            }
            
            btn.disabled = false;
            btn.textContent = 'üåê Test CORS Configuration';
        }

        async function simulateOAuthFlow() {
            const btn = document.getElementById('oauthTestBtn');
            const results = document.getElementById('oauthResults');
            
            btn.disabled = true;
            btn.textContent = 'üîÑ Testing...';
            
            results.innerHTML = '<div class="status-box status-warning"><i class="fas fa-spinner fa-spin"></i> Simulating LinkedIn OAuth exchange...</div>';
            
            // Create realistic test payload
            const testPayload = {
                code: 'AQTjX4cI9nI4X4cI9nI4X4cI9nI4X4cI9nI4', // Mock LinkedIn auth code format
                state: 'test_state_' + Math.random().toString(36).substr(2, 9),
                redirectUri: REDIRECT_URI
            };
            
            try {
                const response = await fetch(API_ENDPOINT, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Origin': window.location.origin
                    },
                    body: JSON.stringify(testPayload)
                });
                
                const responseText = await response.text();
                let responseData;
                
                try {
                    responseData = JSON.parse(responseText);
                } catch (e) {
                    responseData = { rawResponse: responseText };
                }
                
                let statusClass = 'status-fail';
                let statusMessage = '‚ùå OAuth simulation failed';
                
                // Check for specific LinkedIn error patterns
                if (response.status === 400 && responseText.includes('invalid_client')) {
                    statusMessage = '‚ùå LinkedIn returned "invalid_client" - check client secret';
                } else if (response.status === 400 && responseText.includes('redirect_uri')) {
                    statusMessage = '‚ùå LinkedIn returned redirect URI mismatch';
                } else if (response.status === 500) {
                    statusMessage = '‚ùå Server error - check environment variables';
                } else if (response.status === 401) {
                    statusMessage = '‚ùå Authentication error with LinkedIn';
                } else if (responseText.includes('Token exchange failed')) {
                    statusMessage = '‚ùå LinkedIn token exchange failed';
                    statusClass = 'status-warning';
                } else if (responseText.includes('Missing required parameters')) {
                    statusMessage = '‚ö†Ô∏è API parameter validation issue';
                    statusClass = 'status-warning';
                }
                
                results.innerHTML = `
                    <div class="status-box ${statusClass}">
                        <h4>${statusMessage}</h4>
                        <p><strong>Status Code:</strong> ${response.status}</p>
                        <p><strong>Response Type:</strong> ${response.headers.get('content-type') || 'Unknown'}</p>
                    </div>
                    <div class="api-response">
REQUEST:
${JSON.stringify(testPayload, null, 2)}

RESPONSE (${response.status}):
${JSON.stringify(responseData, null, 2)}
                    </div>
                `;
                
                // If we get a reasonable error from LinkedIn API, CORS and routing are working
                if (response.status === 400 && (responseText.includes('invalid') || responseText.includes('Token exchange failed'))) {
                    testResults.oauthWorking = true;
                    updateRealTestButton();
                }
                
            } catch (error) {
                results.innerHTML = `
                    <div class="status-box status-fail">
                        <h4>‚ùå Network error during OAuth simulation</h4>
                        <p><strong>Error:</strong> ${error.message}</p>
                        <p>This suggests a CORS or network connectivity issue.</p>
                    </div>
                `;
            }
            
            btn.disabled = false;
            btn.textContent = 'üß™ Simulate OAuth Exchange';
        }

        function checkLinkedInConfig() {
            const config = `
üìã LinkedIn App Configuration Checklist:

1. Go to: https://developer.linkedin.com/apps/3471394/auth

2. Verify these redirect URLs are ALL added:
   ‚úÖ https://sociallyfounded.com/linkedin-callback.html
   ‚úÖ https://www.sociallyfounded.com/linkedin-callback.html  
   ‚úÖ https://socially-founded.vercel.app/linkedin-callback.html

3. Verify OAuth 2.0 scopes are enabled:
   ‚úÖ openid
   ‚úÖ profile
   ‚úÖ email

4. Verify "Sign In with LinkedIn using OpenID Connect" product is added

5. Check that your Client Secret matches: WPL_AP1.vV3sYWZIFx13yovS.Y/eb9w==

Common Issues:
‚ùå Missing www. subdomain in redirect URLs
‚ùå HTTP instead of HTTPS in redirect URLs  
‚ùå Trailing slash differences in URLs
‚ùå Scopes not approved (should be automatic for Sign In)
            `;
            
            alert(config);
        }

        function testRealLinkedIn() {
            const state = generateRandomString(16);
            sessionStorage.setItem('linkedin_oauth_state', state);
            sessionStorage.setItem('linkedin_diagnostic_test', 'true');
            
            const authUrl = 'https://www.linkedin.com/oauth/v2/authorization?' +
                `response_type=code&` +
                `client_id=${LINKEDIN_CLIENT_ID}&` +
                `redirect_uri=${encodeURIComponent(REDIRECT_URI)}&` +
                `state=${state}&` +
                `scope=openid%20profile%20email`;
            
            console.log('Starting LinkedIn OAuth test:', {
                clientId: LINKEDIN_CLIENT_ID,
                redirectUri: REDIRECT_URI,
                state: state,
                authUrl: authUrl
            });
            
            // Show diagnostic info before redirect
            const summary = document.getElementById('diagnosticSummary');
            const content = document.getElementById('summaryContent');
            
            content.innerHTML = `
                <div class="status-box status-warning">
                    <h4>üîó Redirecting to LinkedIn...</h4>
                    <p><strong>State:</strong> ${state}</p>
                    <p><strong>Redirect URI:</strong> ${REDIRECT_URI}</p>
                    <p><strong>Auth URL:</strong> ${authUrl.substring(0, 100)}...</p>
                    <p><em>You will be redirected to LinkedIn, then back to your callback.</em></p>
                </div>
            `;
            summary.style.display = 'block';
            
            setTimeout(() => {
                window.location.href = authUrl;
            }, 2000);
        }

        function updateRealTestButton() {
            const btn = document.getElementById('realTestBtn');
            const allTestsPassed = testResults.apiWorking && testResults.corsWorking && testResults.oauthWorking;
            
            if (allTestsPassed) {
                btn.disabled = false;
                btn.className = 'test-btn success';
                btn.textContent = '‚úÖ Test Real LinkedIn OAuth';
            } else {
                btn.disabled = false;
                btn.className = 'test-btn danger';
                btn.textContent = '‚ö†Ô∏è Test Real LinkedIn OAuth (Some tests failed)';
            }
        }

        function generateRandomString(length) {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
            let result = '';
            for (let i = 0; i < length; i++) {
                result += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return result;
        }

        // Auto-run API test on page load
        window.addEventListener('load', () => {
            setTimeout(testAPIEndpoint, 1000);
        });
    </script>
</body>
</html>
